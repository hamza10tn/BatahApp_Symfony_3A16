{% extends 'base.html.twig' %}

{% block profileBlock %}

    {% if user.role == "U" %}

        {% block dashboard %}

        {% endblock %}

    {% endif %}

    {% if user.role == "U" %}
        {% block partenaires %}

        {% endblock %}

    {% endif %}
    {% if user.role == "U" %}
        {% block messages %}

        {% endblock %}

    {% endif %}
    <li class="user_setting">
        <div class="dropdown">
            <a class="btn dropdown-toggle" href="#" data-bs-toggle="dropdown">
                {% if user.getAvatar() is not null %}
                    <img class="rounded-circle mr10" src="{{ asset('/image/uploads/' ~ user.getAvatar()) }}" height="40px" width="40px" alt="{{ user.getAvatar() }}">
                {% else %}
                    <img class="rounded-circle mr10" src="{{ asset('/image/uploads/upload_photo.png') }}" height="40px" width="40px" alt="Default Avatar">
                {% endif %}
                <span class="dn-1366">{{ user.getNomutilisateur() ~ " " ~ user.getPrenomutilisateur() }} <span class="fas fa-angle-down ml5"></span></span>
            </a>

            <div class="dropdown-menu">
                <div class="user_set_header">
                    {% if user.getAvatar() is not null %}
                        <img class="float-start rounded-circle" src="{{ asset('/image/uploads/' ~ user.getAvatar()) }}" alt="{{ user.getAvatar() }}" height="40px" width="40px">
                    {% else %}
                        <img class="float-start rounded-circle" src="{{ asset('/image/uploads/upload_photo.png') }}" alt="Default Avatar" height="40px" width="40px">
                    {% endif %}
                    <p>{{ user.getNomutilisateur() ~ " " ~ user.getPrenomutilisateur() }} <br><span class="address">{{ user.getAdresseemail() }}</span></p>
                </div>
                <div class="user_setting_content">
                    <a class="dropdown-item active" href="{{ path('profile') }}">My Profile</a>
                    <a class="dropdown-item" href="#">Messages</a>
                    <a class="dropdown-item" href="#">My Listing</a>
                    <a class="dropdown-item" href="#">Help</a>
                    <a class="dropdown-item" href="#">Log out</a>
                </div>
            </div>
        </div>
    </li>
{% endblock %}

{% block pane %}
    <form id="csv-upload-form" method="post" enctype="multipart/form-data">
        <input type="file" name="csv_file" required>
        <button type="submit">Upload CSV</button>
    </form>

    <!-- This div will be used to display the CSV data table -->
    <div id="csv-data-display"></div>

    <script>
        document.getElementById('csv-upload-form').addEventListener('submit', function(e) {
            e.preventDefault();
            var formData = new FormData(this);
            fetch('/upload-csv', {
                method: 'POST',
                body: formData,
            })
                .then(response => response.text())
                .then(html => {
                    document.getElementById('csv-data-display').innerHTML = html;
                    // Reinitialize checkbox toggling script to work with dynamically loaded content
                    initializeCheckboxes();
                })
                .catch(error => console.error('Error:', error));
        });

        function initializeCheckboxes() {
            const checkAllBox = document.getElementById('check_all');
            if (checkAllBox) {
                checkAllBox.onclick = function() {
                    const checkboxes = document.querySelectorAll('.row_checkbox');
                    for (let checkbox of checkboxes) {
                        checkbox.checked = this.checked;
                    }
                };
            }
        }
        function deleteRow(rowId) {
            let checkbox = document.querySelector(`input[data-row-id="${rowId}"]`);

                let row = document.getElementById(`row-${rowId}`);
                if (row) {
                    row.remove();
                }

        }
        // Delete all selected rows
        function deleteSelectedRows() {
            let checkboxes = document.querySelectorAll('.row_checkbox:checked');
            checkboxes.forEach(checkbox => {
                let rowId = checkbox.getAttribute('data-row-id');
                let row = document.getElementById(`row-${rowId}`);
                if (row) {
                    row.remove();
                }
            });

            // Optionally uncheck the master checkbox
            document.getElementById('check_all').checked = false;
        }

        function sendSelectedRowsToController() {
            const selectedRows = [];
            document.querySelectorAll('.row_checkbox:checked').forEach(checkbox => {
                selectedRows.push(JSON.parse(checkbox.getAttribute('data-row-data')));
            });

            fetch('/handle-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(selectedRows),
            })
                .then(response => response.json())
                .then(data => {

                    if (data.status === 'error') {
                        alert('Erreur: ' + data.message);
                    } else {
                        alert('Succès: ' + data.message);
                        deleteSelectedRows(); // Supprimer les lignes seulement en cas de succès
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert('Erreur: ' + data.message);
                });
        }

    </script>

{% endblock %}
